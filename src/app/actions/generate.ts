'use server';

import { openai } from '@/lib/openai';

if (!process.env.OPENAI_API_KEY) {
  throw new Error('Missing OpenAI API Key');
}

export const runtime = 'edge';

export async function generatePlan(prompt: string) {
  try {
    const enhancedSystemPrompt = `당신은 15년 경력의 CSR(기업 사회공헌 활동) 전문 기획자이자 컨설턴트입니다.
        주어진 요구사항을 바탕으로 실현 가능하고 구체적인 기획안을 작성해주세요.

        다음 형식을 반드시 준수하여 응답해주세요:

        각 섹션에 대해 구체적이고 실질적인 내용을 포함하되, 현실적으로 실현 가능한 제안을 해주세요.
        수치와 데이터를 최대한 활용하고, 업계 트렌드와 베스트 프랙티스를 반영해주세요.

        마지막으로, 제안된 기획안의 차별화 포인트와 혁신적 요소를 명확히 제시해주세요.
        
        아래는 지금까지 제공된 CSR 사회공헌 활동에 대한 데이터입니다.
        
        대규모 프로젝트 (10억원~100억원 수준)
        삼성 드림클래스교육 격차 해소를 위한 장기 프로젝트
        농어촌 및 저소득층 학생들에게 대학생 멘토링 제공
        연간 약 100억원 규모로 운영
        2012년부터 10년 이상 지속된 대표적 장기 프로젝트
        현대차그룹 '온드림 스쿨'청소년 교육 지원 종합 프로그램
        수학·과학 영재 교육, 예술 영재 교육, 체육 영재 교육 등
        연간 약 50억원 규모
        SK 행복나눔재단의 '행복도시락'결식 아동과 취약계층을 위한 도시락 지원 사업
        사회적 기업 모델로 발전
        연간 30억원 이상 투자
        LG 희망 스퀘어개발도상국 직업 훈련센터 건립 및 운영
        국가별 20~30억원 규모의 센터 설립
        에티오피아, 케냐, 방글라데시 등에서 운영
        중규모 프로젝트 (1억원~10억원 수준)
        포스코 '포스코 1% 나눔재단'직원들의 급여 1% 기부와 회사 매칭 그랜트로 운영
        청소년 교육, 다문화가정 지원 등 다양한 사업 진행
        개별 프로젝트별 3억~5억원 규모
        KB금융그룹 'KB희망캠프'저소득층 청소년 대상 진로 탐색 및 교육 프로그램
        연간 5억원 내외 규모
        롯데그룹 'mom편한 놀이터'아동 친화적 공간 조성 사업
        한 곳당 약 3억원 규모, 전국적으로 확대 중
        네이버 '해피빈'온라인 기부 플랫폼 운영
        다양한 공익단체 지원 및 매칭 기부
        개별 프로젝트 지원 규모는 1억~5억원 수준
        CJ나눔재단 '꿈키움아카데미'외식 산업 직업 교육 프로그램
        취약계층 청년 대상 셰프 양성 사업
        연간 약 7억원 규모
        한화그룹 '한화 사이언스 챌린지'청소년 과학 영재 발굴 및 지원 프로그램
        연간 약 5억원 규모

        LG헬로비전이 임직원 기부를 해피빈으로 진행하는 구체적인 방법에 대해 설명해 드리겠습니다.
        일반적으로 기업이 네이버 해피빈을 통해 임직원 기부를 진행하는 방식은 다음과 같습니다:
        해피빈 기업 기부 프로그램 운영 방식
        기업 전용 기부 페이지 개설LG헬로비전 전용 기부 페이지를 해피빈에 개설
        회사명과 로고가 포함된 맞춤형 페이지 제작
        임직원 참여 방법사내 인트라넷이나 이메일을 통해 해피빈 기부 링크 공유
        임직원들이 개인 네이버 계정으로 로그인하여 기부 참여
        또는 회사 계정을 통한 일괄 기부 시스템 구축
        기부 방식 선택정기 기부: 매월 일정 금액 자동 기부
        일시 기부: 캠페인별 참여
        콩(해피빈 포인트) 기부 또는 실제 현금 기부
        매칭 그랜트(Matching Grant) 프로그램임직원이 기부한 금액만큼 회사도 동일한 금액 기부
        예: 임직원이 1만원 기부 시 회사도 1만원 기부하여 총 2만원 기부
        기부처 선정 방식회사가 미리 선정한 특정 기부처에 집중 기부
        또는 임직원들이 해피빈에 등록된 다양한 단체 중 선택 가능
        사내 투표를 통해 기부처 선정하는 참여형 방식도 가능
        LG헬로비전의 경우, 구체적인 운영 방식은 회사 내부 정책에 따라 달라질 수 있으며, 일반적으로 사회공헌팀이나 HR팀에서 프로그램을 관리합니다. 임직원들은 사내 공지를 통해 참여 방법, 기간, 매칭 그랜트 여부 등에 대한 안내를 받게 됩니다.
        
        나비얌이라는 플랫폼에서는 기업 사회공헌 예산을 받아 급식카드 인증을 받은 결식아동에게 인원수 제한을 둬서 기프트카드 혹은 쿠폰 형태로 지급하는 캠페인을 주로 열고 있어. 도시락 전달 봉사 활동 캠페인도 있었어. 나비얌에는 다양한 배송상품들과 바코드 상품들이 있어서 이를 이용해 사회공헌 캠페인을 하기도 해`;

    const completion = await openai.chat.completions.create({
      messages: [
        {
          role: 'system',
          content: enhancedSystemPrompt,
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      model: 'gpt-4o',
      temperature: 0.7,
      max_tokens: 4000, // 응답 길이 증가
      presence_penalty: 0.3, // 다양한 주제를 다루도록 유도
      frequency_penalty: 0.3, // 반복 줄이기
    });

    // 응답 구조화 및 포맷팅
    const response = completion.choices[0].message.content;

    return {
      success: true,
      content: response,
    };
  } catch (error) {
    console.error('OpenAI API 에러:', error);
    return {
      success: false,
      error: '기획안 생성 중 오류가 발생했습니다.',
    };
  }
}
